<!DOCTYPE html><html lang="en"><head><title>lib/builder</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="lib/builder"><meta name="groc-project-path" content="lib/builder.js"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">lib/builder.js</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-pi">'use strict'</span>;
<span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>),
  path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>),
  <span class="hljs-keyword">async</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'async'</span>),
  LOG = <span class="hljs-built_in">require</span>(<span class="hljs-string">'winston'</span>),
  glob = <span class="hljs-built_in">require</span>(<span class="hljs-string">'glob'</span>),
  chalk = <span class="hljs-built_in">require</span>(<span class="hljs-string">'chalk'</span>),
  templates = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./templates.js'</span>),
  <span class="hljs-comment">//! alias = require('./alias'),</span>
  _ = <span class="hljs-built_in">require</span>(<span class="hljs-string">'lodash'</span>),
  jsonminify = <span class="hljs-built_in">require</span>(<span class="hljs-string">'jsonminify'</span>),
  rimraf = <span class="hljs-built_in">require</span>(<span class="hljs-string">'rimraf'</span>),
  EOL = <span class="hljs-built_in">require</span>(<span class="hljs-string">'os'</span>).EOL,
  exec = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./utils/executor'</span>),
  copier = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./utils/copier'</span>),
  meta = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./utils/meta'</span>),
  writer = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./writer'</span>),
  linter = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./lint/linter'</span>),
  rollups = [],
  config = {},
  lintConfig = {},
  defaultConfig = {
    regex: <span class="hljs-string">'^(?!\\s*?\\*).*(?:Y.log)(.*\n*)*?.*\\);.*|^.*?(?:/\\*@DBG\\*/).*\\r?\\n|^.*?(?:/\\*@DBG@\\*/).*\\r?\\n'</span>,
    target: path.join(process.cwd(), <span class="hljs-string">'target'</span>)
  };

<span class="hljs-keyword">if</span> (<span class="hljs-regexp">/^win/</span>.test(process.platform)) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This is done only on windows. Adding graceful-fs makes everything slower.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-built_in">require</span>(<span class="hljs-string">'graceful-fs'</span>).gracefulify(fs);
}

<span class="hljs-comment">/**! Replace the content with the given keys.
 * @param content {string} The current content.
 * @param keys {array} The keys to be replaced.
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">replace</span>(<span class="hljs-params">content, keys</span>) </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/^win/</span>.test(process.platform)) {
    <span class="hljs-keyword">return</span> replaceWindows(content, keys);
  }

  _.forEach(_.merge(config, keys || {}), <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">value, key</span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If the key does not have <code>@key@</code>, it will be added.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (key.indexOf(<span class="hljs-string">'\@'</span>) != <span class="hljs-number">0</span>) {
      key = <span class="hljs-string">'\@'</span> + key + <span class="hljs-string">'\@'</span>;
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Replace the given key in the entire content.</p></div></div><div class="code"><div class="wrapper">    content = content.replace(<span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(key, <span class="hljs-string">'mgi'</span>), value);
  });
  <span class="hljs-keyword">return</span> content;
};

<span class="hljs-comment">/**! Replace the content with the given keys.
 * @param content {string} The current content.
 * @param keys {array} The keys to be replaced.
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">replaceWindows</span>(<span class="hljs-params">content, keys</span>) </span>{
  <span class="hljs-keyword">var</span> result = <span class="hljs-string">''</span>;

  _.forEach(content.split(EOL), <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">line</span>) </span>{
    <span class="hljs-keyword">var</span> aux = line;
    _.forEach(_.merge(config, keys || {}), <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">value, key</span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If the key does not have <code>@key@</code>, it will be added.</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">if</span> (key.indexOf(<span class="hljs-string">'\@'</span>) != <span class="hljs-number">0</span>) {
        key = <span class="hljs-string">'\@'</span> + key + <span class="hljs-string">'\@'</span>;
      }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Replace the given key in the entire content.</p></div></div><div class="code"><div class="wrapper">      aux = aux.replace(<span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(key, <span class="hljs-string">'mgi'</span>), value);
    });
    result += aux + EOL;
  });

  <span class="hljs-keyword">return</span> result;
};

<span class="hljs-comment">/**! Check that the path is valid.
 * @param base {string} The base path.
 * @param file {string} The current file.
 * @param type {string} The file type (js or css).
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkPath</span>(<span class="hljs-params">base, file, type</span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Checks if the path starts with the type (<code>js or css</code>).</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">if</span> (path.normalize(file).indexOf(type + path.sep) !== <span class="hljs-number">0</span>) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If not add the type.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">return</span> path.join(base, type, file);
  }
  <span class="hljs-keyword">return</span> path.join(base, file);
}

<span class="hljs-comment">/**! Append the given file to the given content.
 * @param content {string} The content to append the file.
 * @param file {string} The file to append.
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">append</span>(<span class="hljs-params">content, file</span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Check that the file exists.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">if</span> (fs.existsSync(file)) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Append the file to the given content</p></div></div><div class="code"><div class="wrapper">    content = content + fs.readFileSync(file, <span class="hljs-string">'utf8'</span>) + EOL;
  } <span class="hljs-keyword">else</span> {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If the file doesnt exist just notify the user.</p></div></div><div class="code"><div class="wrapper">    LOG.debug(file + <span class="hljs-string">' Does not exist.'</span>);
  }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Return the content.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">return</span> content;
}

<span class="hljs-keyword">var</span> builder = {
  <span class="hljs-comment">/**! Load the configuration.
   * @param options {object} The given options for the builder.
   * @param lintOptions {object} The jshint options.
   */</span>
  load: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">options, lintOptions</span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Merge the options with the default options.</p></div></div><div class="code"><div class="wrapper">    config = _.merge(defaultConfig, options || {});
    lintConfig = lintOptions || {};
    <span class="hljs-comment">//! if (config.aka) {</span>
    <span class="hljs-comment">//!   alias.load();</span>
    <span class="hljs-comment">//! }</span>
  },

  <span class="hljs-comment">/**! Start a full build.
   * @param base {string} The base path.
   * @param callback {function} The callback to be called with the results.
   */</span>
  build: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">base, callback</span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Search for every available module under the base path. <code>Reverse</code> is added to be compatible with <code>shifter</code>.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">var</span> files = glob.sync(path.join(base, <span class="hljs-string">'**'</span>, <span class="hljs-string">'build.json'</span>)).reverse(),
      each = <span class="hljs-keyword">async</span>.eachLimit;

    LOG.info(chalk.blue(<span class="hljs-string">'Building '</span> + files.length + <span class="hljs-string">' modules'</span>));</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Clean the target folder</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (!config.dry) {
      LOG.debug(<span class="hljs-string">'Removing target folder'</span>);
      rimraf.sync(config.target);
    }

    <span class="hljs-comment">//! Alias need sequential loop.</span>
    <span class="hljs-comment">//! if (config.aka) {</span>
    <span class="hljs-comment">//!   each = async.eachSeries;</span>
    <span class="hljs-comment">//! }</span>

    each(files, <span class="hljs-number">20</span>, builder.buildModule, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
      <span class="hljs-keyword">if</span> (err) {
        callback(err);
      }
      builder.rollup(callback);
    });
  },

  <span class="hljs-comment">/**! Build a single module.
   * @param file {string} The ```build.json``` file.
   * @param next {function} The callback to be called when the build is done.
   */</span>
  buildModule: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">file, next</span>) </span>{
    <span class="hljs-keyword">var</span> descriptor = <span class="hljs-built_in">JSON</span>.parse(fs.readFileSync(file)),
      base = path.dirname(file),
      cache,
      assetsBase,
      moduleName,
      metaData;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Run the prebuilds for the current build.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (descriptor.prebuilds) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Save the current descriptor to be used when the prebuilds are done.</p></div></div><div class="code"><div class="wrapper">      cache = descriptor;
      _.forEach(descriptor.prebuilds, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">prebuild</span>) </span>{
        LOG.debug(<span class="hljs-string">'prebuild: '</span> + prebuild);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Build the prebuilds</p></div></div><div class="code"><div class="wrapper">        builder.buildModule(path.join(base, <span class="hljs-string">'..'</span>, prebuild, <span class="hljs-string">'build.json'</span>), <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
          <span class="hljs-keyword">if</span> (err) {
            LOG.debug(<span class="hljs-built_in">JSON</span>.stringify(descriptor));
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(err);
          }
        });
      });</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Copy the original descriptor.</p></div></div><div class="code"><div class="wrapper">      descriptor = cache;
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The base path for the module.</p></div></div><div class="code"><div class="wrapper">    base = path.dirname(file);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The assets path for the module.</p></div></div><div class="code"><div class="wrapper">    assetsBase = path.join(base, <span class="hljs-string">'assets'</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The module name.</p></div></div><div class="code"><div class="wrapper">    moduleName = descriptor.name;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The meta data object for this module.</p></div></div><div class="code"><div class="wrapper">    metaData = meta.get(base);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This build was already built by pre/post builds</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (fs.existsSync(path.join(config.target, moduleName)) &amp;&amp; config.gallop) {
      LOG.debug(<span class="hljs-string">'Skiping second build of '</span> + moduleName);
      next();
      <span class="hljs-keyword">return</span>;
    }

    LOG.info(<span class="hljs-string">'Building '</span> + moduleName);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Add the rollups to the rollups object so they can be build after the current build.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (descriptor.rollups) {
      _.forEach(descriptor.rollups, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">rollup, name</span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Set the rollup name.</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-keyword">if</span> (!rollup.name &amp;&amp; !rollup.basefilename) {
          rollup.name = name;
        }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Check that the rollup was not already added.</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-keyword">if</span> (_.findIndex(rollups, rollup) &lt; <span class="hljs-number">0</span>) {
          rollups.push(rollup);
        }
      });
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Execute the execs defined by the descriptor.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (descriptor.exec) {
      exec.execute(descriptor.exec, base);
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Build each files.</p></div></div><div class="code"><div class="wrapper">    _.forEach(descriptor.builds, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">build, name</span>) </span>{
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> build === <span class="hljs-string">'string'</span>) {
        <span class="hljs-keyword">return</span>;
      }

      LOG.debug(<span class="hljs-string">'Building '</span> + name);
      <span class="hljs-keyword">var</span> content,
        properties = _.merge(build, meta.getProperties(metaData, name, moduleName));</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Add the descriptor properties as the parent properties</p></div></div><div class="code"><div class="wrapper">      properties = _.merge(properties, {
        parent: descriptor.shifter || {}
      });</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Execute the execs defined for the module.</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">if</span> (properties.exec) {
        exec.execute(properties.exec, base);
      }

      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">if</span> (build.jsfiles &amp;&amp; build.jsfiles.length) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Build as javascript module.</p></div></div><div class="code"><div class="wrapper">          builder.js(name, build.jsfiles, properties, base);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (build.cssfiles &amp;&amp; build.cssfiles.length) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Build as css module.</p></div></div><div class="code"><div class="wrapper">          builder.css(name, build.cssfiles, properties, base);
        }
      } <span class="hljs-keyword">catch</span> (e) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If something went wrong, the <code>next</code> function is called with an error.</p></div></div><div class="code"><div class="wrapper">        next(e);
      }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Execute the post build execs defined for the module.</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">if</span> (properties.postexec) {
        exec.execute(properties.postexec, base);
      }
    });</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If any rollup is present, build them.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (rollups.length &gt; <span class="hljs-number">0</span> &amp;&amp; !config.unique) {
      builder.rollup();
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Execute the post build execs defined by the descriptor.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (descriptor.postexec) {
      exec.execute(descriptor.postexec, base);
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If the assets folder is present copy all the static content.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (fs.existsSync(assetsBase) &amp;&amp; !config.dry) {
      LOG.debug(<span class="hljs-string">'Copying assets for '</span> + moduleName);
      copier.assets(assetsBase, config.target, moduleName);
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Run the postbuilds for the current build.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (descriptor.postbuilds) {
      _.forEach(descriptor.postbuilds, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">prebuild</span>) </span>{
        LOG.debug(<span class="hljs-string">'postbuilds: '</span> + prebuild);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Build the postbuilds</p></div></div><div class="code"><div class="wrapper">        builder.buildModule(path.join(base, <span class="hljs-string">'..'</span>, prebuild, <span class="hljs-string">'build.json'</span>), <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
          <span class="hljs-keyword">if</span> (err) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(err);
          }
        })
      });
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Run the next build without errors.</p></div></div><div class="code"><div class="wrapper">    next();
  },

  <span class="hljs-comment">/**! Build the rollups for the current module.
   * @param file {string} The ```build.json``` file.
   * @param next {function} The callback to be called when the build is done.
   */</span>
  rollup: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">callback</span>) </span>{
    LOG.info(<span class="hljs-string">'Building rollups'</span>);
    <span class="hljs-keyword">async</span>.each(rollups, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">rollup</span>) </span>{
      <span class="hljs-keyword">var</span> content = <span class="hljs-string">''</span>,
        filename = rollup.basefilename || rollup.name;
      LOG.info(<span class="hljs-string">'Creating rollup: '</span> + filename);

      _.forEach(rollup.files, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">file</span>) </span>{
        <span class="hljs-keyword">var</span> filePath,
          basePath = path.join(config.target, file);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Check if the rollup needs the language files.</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-keyword">if</span> (rollup.lang) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Go through the languages and add it to the rollup.</p></div></div><div class="code"><div class="wrapper">          _.forEach(rollup.lang, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">lang</span>) </span>{
            content = append(content, path.join(basePath, <span class="hljs-string">'lang'</span>, file + <span class="hljs-string">'_'</span> + lang + <span class="hljs-string">'.js'</span>));
          });
        }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Concatenate all the <code>debug</code> versions of the modules.</p></div></div><div class="code"><div class="wrapper">        filePath = path.join(basePath, file + <span class="hljs-string">'-debug.js'</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If the file does not exist dont do anything. It must be a typo.</p></div></div><div class="code"><div class="wrapper">        content = append(content, filePath);
      });</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Wrap the content with the necesary YUI custom template.</p></div></div><div class="code"><div class="wrapper">      content = templates.rollup({
        body: content,
        version: config.version,
        config: <span class="hljs-built_in">JSON</span>.stringify(rollup.config),
        name: rollup.name
      });

      <span class="hljs-keyword">if</span> (!config.dry) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Write the output files.</p></div></div><div class="code"><div class="wrapper">        writer.js(replace(content, rollup.replace), path.join(config.target, filename, filename), rollup.regex || config.regex);
      }
    });</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Clean the rollups for the next build.</p></div></div><div class="code"><div class="wrapper">    rollups = [];</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Call the callback, if any.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (callback) {
      callback();
    }
  },

  <span class="hljs-comment">/**! Build the javascript module.
   * @param name {string} The name of the module.
   * @param files {array} The files to concatenate.
   * @param properties {obejct} The properties for the module.
   * @param base {string} The base path for the module.
   */</span>
  js: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">name, files, properties, base</span>) </span>{
    <span class="hljs-keyword">var</span> content = <span class="hljs-string">""</span>,
      valid,
      data = {
        dependencies: <span class="hljs-built_in">JSON</span>.stringify(properties.requires || [], <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>).replace(<span class="hljs-regexp">/\"/g</span>, <span class="hljs-string">'\''</span>),
        name: properties.name || name,
        version: config.version
      },
      filename = properties.basefilename || name,
      generated = properties.shifter &amp;&amp; properties.shifter.generated,
      addStamp = properties.shifter &amp;&amp; properties.shifter.jsstamp !== <span class="hljs-literal">false</span>,
      useStamp = properties.shifter &amp;&amp; properties.shifter.usestamp;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If lang is present, add lang to the template data.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (properties.lang) {
      data.lang = <span class="hljs-built_in">JSON</span>.stringify(properties.lang, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>).replace(<span class="hljs-regexp">/\"/g</span>, <span class="hljs-string">'\''</span>);
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This is not documented in shifter but used in autocomplete-base.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (properties.optional) {
      data.optional = <span class="hljs-built_in">JSON</span>.stringify(properties.optional || {}, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>).replace(<span class="hljs-regexp">/\"/g</span>, <span class="hljs-string">'\''</span>);
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If the module is skinnable, add it to the template data.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (properties.skinnable) {
      data.skinnable = properties.skinnable;
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Add any extra configuration present.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (properties.config) {
      data.config = <span class="hljs-built_in">JSON</span>.stringify(properties.config).slice(<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>).replace(<span class="hljs-regexp">/\"/g</span>, <span class="hljs-string">'\''</span>);
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Lint and Concatenate all the javascript files.</p></div></div><div class="code"><div class="wrapper">    _.forEach(files, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">file</span>) </span>{
      <span class="hljs-keyword">var</span> tmpBuff, filePath = checkPath(base, file, <span class="hljs-string">'js'</span>);
      <span class="hljs-keyword">if</span> (fs.existsSync(filePath)) {
        tmpBuff = fs.readFileSync(filePath, <span class="hljs-string">'utf8'</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If the file is not auto-generated and lint is not disabled, run lint.</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-keyword">if</span> (!generated &amp;&amp; properties.parent.lint !== <span class="hljs-literal">false</span> &amp;&amp; config.lint !== <span class="hljs-literal">false</span>) {
          valid = linter.verify(config.linter, tmpBuff, lintConfig, name);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If jshint fails and the properties does not cover it, fail the build.</p></div></div><div class="code"><div class="wrapper">          <span class="hljs-keyword">if</span> (!valid &amp;&amp; properties.fail !== <span class="hljs-literal">false</span> &amp;&amp; properties.parent.fail !== <span class="hljs-literal">false</span> &amp;&amp; config.fail !== <span class="hljs-literal">false</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Lint failed for module '</span> + name);
          }
        }
        content += tmpBuff;
      }
    });

    data.body = content;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Wrape it using the <code>use</code> template.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (useStamp) {
      content = templates.use(data);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!properties.shifter || addStamp) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Wrape it using the <code>add</code> template.</p></div></div><div class="code"><div class="wrapper">      content = templates.add(data);
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Preapend files defined by the properties.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (properties.prependfiles) {
      _.forEach(properties.prependfiles, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">append</span>) </span>{
        <span class="hljs-keyword">var</span> fileContent = fs.readFileSync(checkPath(base, append, <span class="hljs-string">'js'</span>), <span class="hljs-string">'utf8'</span>);
        content = fileContent + EOL + content;
      });
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Append files defined by the properties.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (properties.appendfiles) {
      _.forEach(properties.appendfiles, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">append</span>) </span>{
        <span class="hljs-keyword">var</span> fileContent = fs.readFileSync(checkPath(base, append, <span class="hljs-string">'js'</span>), <span class="hljs-string">'utf8'</span>);
        content = content + EOL + fileContent;
      });
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Replace all the <code>replace--XXX</code> properties.</p></div></div><div class="code"><div class="wrapper">    content = replace(content, properties.replace);

    <span class="hljs-keyword">if</span> (!config.dry) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Write the output files.</p></div></div><div class="code"><div class="wrapper">      writer.js(content, path.join(config.target, filename, filename), config.regex || properties.regex);
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If I18N is present, write the language files.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (properties.lang &amp;&amp; !config.dry) {
      writer.lang(properties.lang, path.join(base, <span class="hljs-string">'lang'</span>), path.join(config.target, filename, <span class="hljs-string">'lang'</span>, filename), name, data);
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If skin is present, write the skin files.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (properties.skinnable) {
      builder.skin(name, filename, base, properties);
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Copy the folders expressed by the descriptor.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (properties.copy &amp;&amp; !config.dry) {
      copier.copy(properties.copy, base, path.join(config.target, filename));
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Return the content for the javascript module.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">return</span> content;
  },

  <span class="hljs-comment">/**! Build the skin for the current module.
   * @param name {string} The name of the module.
   * @param filename {string} The name for the output file.
   * @param base {string} The base path for the module.
   * @param properties {obejct} The properties for the module.
   */</span>
  skin: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">name, filename, base, properties</span>) </span>{
    <span class="hljs-keyword">var</span> basePath = path.join(base, <span class="hljs-string">'assets'</span>),
      skinPath = path.join(basePath, <span class="hljs-string">'skins'</span>),
      corePath = path.join(basePath, name + <span class="hljs-string">'-core.css'</span>),
      core = <span class="hljs-string">''</span>,
      skins;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Search for the skin folder. There are two options:</p>
<ul>
<li>base path + skins (for simple module).</li>
<li>base path + module name + skins (for modules with submodules that contains skins).</li>
</ul></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (!fs.existsSync(skinPath)) {
      skinPath = path.join(basePath, name, <span class="hljs-string">'skins'</span>);
      corePath = path.join(basePath, name, name + <span class="hljs-string">'-core.css'</span>);
      <span class="hljs-keyword">if</span> (!fs.existsSync(skinPath)) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If the skin is not present return.</p></div></div><div class="code"><div class="wrapper">        LOG.error(name + <span class="hljs-string">' does not have a skin, please remove the skinnable attribute.'</span>);
        <span class="hljs-keyword">return</span>;
      }
    }

    skins = fs.readdirSync(skinPath);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Core css is not needed in the output.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-comment">//! mkdirp.sync(path.join(config.target, filename, 'assets', 'skins'));</span>
    <span class="hljs-keyword">if</span> (fs.existsSync(corePath)) {
      core = fs.readFileSync(corePath);
      <span class="hljs-comment">//! fs.writeFileSync(path.join(config.target, filename, 'assets', filename + '-core.css'), core, 'utf8');</span>
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Run the same procedure for each skin.</p>
<ul>
<li>Concatenate the core and the current skin.</li>
<li>Apply the <code>YUI</code> template for css.</li>
<li>Uglify and minify</li>
</ul></div></div><div class="code"><div class="wrapper">    _.forEach(skins, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">skin</span>) </span>{
      <span class="hljs-keyword">var</span> currentSkin = path.join(skinPath, skin, name + <span class="hljs-string">'-skin.css'</span>),
        targetPath = path.join(config.target, filename, <span class="hljs-string">'assets'</span>, <span class="hljs-string">'skins'</span>, skin),
        skinContent,
        content;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If the skin exists, build it.</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">if</span> (fs.existsSync(currentSkin)) {
        skinContent = fs.readFileSync(currentSkin);
        content = core + EOL + skinContent;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Build the css files.</p></div></div><div class="code"><div class="wrapper">        builder.buildCss(content, targetPath, filename, name, properties);
      } <span class="hljs-keyword">else</span> {
        LOG.debug(<span class="hljs-string">'%s does not exist'</span>, currentSkin)
      }
    });
  },

  <span class="hljs-comment">/**! Build the css module.
   * @param name {string} The name of the module.
   * @param files {array} The files to concatenate.
   * @param properties {obejct} The properties for the module.
   * @param base {string} The base path for the module.
   */</span>
  css: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">name, files, properties, base</span>) </span>{
    <span class="hljs-keyword">var</span> content,
      data = [],
      filename = properties.basefilename || name,
      targetPath = path.join(config.target, filename);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Read and accumlate all the files.</p></div></div><div class="code"><div class="wrapper">    _.forEach(files, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">file</span>) </span>{
      <span class="hljs-keyword">var</span> filePath = checkPath(base, file, <span class="hljs-string">'css'</span>);
      <span class="hljs-keyword">if</span> (fs.existsSync(filePath)) {
        data.push(fs.readFileSync(filePath, <span class="hljs-string">'utf8'</span>));
      }
    });</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Concatenate all the files.</p></div></div><div class="code"><div class="wrapper">    content = data.join(EOL);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Build the css files.</p></div></div><div class="code"><div class="wrapper">    builder.buildCss(content, targetPath, filename, name, properties);
    <span class="hljs-keyword">return</span> content;
  },

  <span class="hljs-comment">/**! Build the css files.
   * @param data {string} The data to wrap and write to the output files.
   * @param targetPath {string} The output path for the module.
   * @param filename {string} The name for the output file.
   * @param moduleName {string} The name of the module.
   * @param properties {obejct} The properties for the module.
   * @param callback {function} The callback to be called with the results.
   */</span>
  buildCss: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">data, targetPath, filename, moduleName, properties, callback</span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Replace all the <code>replace--XXX</code> properties.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">var</span> content = replace(data, properties.replace),
      valid;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Run <code>csslint</code>, if enabled.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (config.csslint !== <span class="hljs-literal">false</span> &amp;&amp; properties.csslint !== <span class="hljs-literal">false</span>) {
      valid = linter.verify(<span class="hljs-string">'csslint'</span>, content, {}, moduleName);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If an error occured and the fail is set, throw an exception.</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">if</span> (!valid &amp;&amp; properties.fail !== <span class="hljs-literal">false</span> &amp;&amp; properties.parent.fail !== <span class="hljs-literal">false</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'CSSLINT failed for module '</span> + moduleName);
      }
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Wrap the content with the <code>css</code> files to be compatibility with <code>shifter</code>.</p></div></div><div class="code"><div class="wrapper">    content = templates.css({
      body: content,
      name: moduleName
    });

    <span class="hljs-keyword">if</span> (!config.dry) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Write the output files.</p></div></div><div class="code"><div class="wrapper">      writer.css(content, path.join(targetPath, filename));
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Call the callback, if any.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (callback) {
      callback(content);
    }
  }
};

<span class="hljs-built_in">module</span>.exports = builder;</div></div></div></div></body></html>